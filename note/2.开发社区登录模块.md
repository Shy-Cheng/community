# 2.开发社区登录模块

## 1. 发送邮件

* 邮箱设置

  * 启用客户端SMTP服务

* Spring Email

  * 导入 jar 包

  ```Java
  <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-mail</artifactId>
  </dependency>
  ```

  * 邮箱参数配置

  ```Properties
  # MailProperties
  spring.mail.username=xxxxxxxxxx@qq.com
  spring.mail.password=xxxxxxxxxxxx  // 授权密码，非登录密码
  spring.mail.host=smtp.qq.com
  spring.mail.properties.mail.smtp.ssl.enable=true
  
  
  ```

  * 使用 JavaMailSender 发送邮件
  * 模板引擎

    * 使用 Thymeleaf 发送 HTML 邮件

  在src/main/java/com/nowcoder/community在新建一个util包，并创建MailClient类

  ```Java
  package com.nowcoder.community.util;
  
  import org.slf4j.Logger;
  import org.slf4j.LoggerFactory;
  import org.springframework.beans.factory.annotation.Autowired;
  import org.springframework.beans.factory.annotation.Value;
  import org.springframework.mail.javamail.JavaMailSender;
  import org.springframework.mail.javamail.MimeMessageHelper;
  import org.springframework.stereotype.Component;
  
  import javax.mail.MessagingException;
  import javax.mail.internet.MimeMessage;
  
  @Component
  public class MailClient {
  
      private static final Logger logger = LoggerFactory.getLogger(MailClient.class);
  
      @Autowired
      private JavaMailSender mailSender;
  
      @Value("${spring.mail.username}")
      private String from;
  
      public void sendMail(String to, String subject, String content) {
          try {
              MimeMessage message = mailSender.createMimeMessage();
              MimeMessageHelper helper = new MimeMessageHelper(message);
              helper.setFrom(from);
              helper.setTo(to);
              helper.setSubject(subject);
              helper.setText(content, true);
              mailSender.send(helper.getMimeMessage());
          } catch (MessagingException e) {
              logger.error("发送邮件失败：" + e.getMessage());
          }
      }
  }
  ```

  在src/main/resources/templates/demo下创建testMail.html文件

  ```html
  <!DOCTYPE html>
  <html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
      <meta charset="UTF-8">
      <title>html邮件</title>
  </head>
  <body>
      <p>欢迎你， <span style="color: red" th:text="${name}"></span></p>
  </body>
  </html>
  ```

  在src/test/java/com/nowcoder/community下新建MailTests类，进行测试

  ```Java
  package com.nowcoder.community;
  
  import com.nowcoder.community.util.MailClient;
  import org.junit.jupiter.api.Test;
  import org.springframework.beans.factory.annotation.Autowired;
  import org.springframework.boot.test.context.SpringBootTest;
  import org.springframework.test.context.ContextConfiguration;
  import org.thymeleaf.TemplateEngine;
  import org.thymeleaf.context.Context;
  
  @SpringBootTest
  @ContextConfiguration(classes = CommunityApplication.class)
  public class MailTests {
  
      @Autowired
      private MailClient mailClient;
  
      @Autowired
      private TemplateEngine templateEngine;
  
      @Test
      public void testTextMail() {
          mailClient.sendMail("1348656979@qq.com", "测试主题", "<h1>测试内容</h1>");
          System.out.println("发送成功");
      }
  
      @Test
      public void testHtmlMail() {
          Context context = new Context();
          context.setVariable("name", "ShayneC");
          String content = templateEngine.process("/demo/testMail", context);
          System.out.println(content);
          mailClient.sendMail("1348656979@qq.com", "html测试", content);
      }
  }
  ```